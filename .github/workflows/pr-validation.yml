name: Pull Request Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate PR Requirements
        run: |
          echo "ğŸ” Validating Pull Request #${{ github.event.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}"
          
          # Check if PR references an issue
          if echo "${{ github.event.pull_request.body }}" | grep -q "#[0-9]"; then
            echo "âœ… PR references an issue"
          else
            echo "âŒ PR doesn't reference an issue - this is required"
            exit 1
          fi
          
          # Check if PR has a description
          if [ -n "${{ github.event.pull_request.body }}" ]; then
            echo "âœ… PR has a description"
          else
            echo "âŒ PR description is empty - this is required"
            exit 1
          fi
          
          # Check if PR title follows convention
          if echo "${{ github.event.pull_request.title }}" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|security):"; then
            echo "âœ… PR title follows conventional commit format"
          else
            echo "âš ï¸ PR title doesn't follow conventional commit format (feat:, fix:, etc.)"
          fi

      - name: Run Security Checks
        run: |
          echo "ğŸ”’ Running security checks..."
          
          # Check for hardcoded secrets
          if grep -r "password\|secret\|key" --include="*.py" --include="*.yml" --include="*.yaml" . | grep -v "test\|example\|config" | grep -v "DB_PASSWORD\|DB_HOST\|DB_USER" | grep -v "getenv\|os.getenv"; then
            echo "âŒ Potential hardcoded secrets found"
            exit 1
          else
            echo "âœ… No hardcoded secrets detected"
          fi
          
          # Check for TODO/FIXME comments
          if grep -r "TODO\|FIXME" --include="*.py" .; then
            echo "âš ï¸ TODO/FIXME comments found - please address before merging"
          fi

      - name: Run Code Quality Checks
        run: |
          echo "ğŸ“Š Running code quality checks..."
          
          # Check Python syntax
          python -m py_compile enhanced_commute_collector_cloud.py
          python -m py_compile config_cloud.py
          python -m py_compile cloud_run_server.py
          echo "âœ… Python syntax check passed"
          
          # Check for common issues
          if grep -r "print(" --include="*.py" . | grep -v "test"; then
            echo "âš ï¸ Print statements found - consider using logging"
          fi

      - name: Test Configuration
        run: |
          echo "ğŸ§ª Testing configuration..."
          
          # Test if config can be imported
          python -c "import config_cloud; print('âœ… Config import successful')"
          
          # Test if required modules can be imported
          python -c "import enhanced_commute_collector_cloud; print('âœ… Main module import successful')"

      - name: Update Project Board
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const issueNumbers = pr.body.match(/#(\d+)/g);
            
            if (issueNumbers) {
              issueNumbers.forEach(issueRef => {
                const issueNum = issueRef.replace('#', '');
                console.log(`PR references issue #${issueNum}`);
                
                try {
                  // Add PR validation comment to issue
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNum,
                    body: `ğŸ” **Pull Request Validation**\n\nPR: #${pr.number}\nTitle: ${pr.title}\nStatus: âœ… Validation passed\nURL: ${pr.html_url}\n\n**Checks Passed:**\n- âœ… References issue\n- âœ… Has description\n- âœ… Security checks passed\n- âœ… Code quality checks passed\n- âœ… Configuration test passed`
                  });
                  console.log(`âœ… Successfully commented on issue #${issueNum}`);
                } catch (error) {
                  console.log(`âš ï¸ Could not comment on issue #${issueNum}: ${error.message}`);
                  console.log(`This is not a critical error - validation still passed`);
                }
              });
            }

  test-deployment:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Docker Build
        run: |
          echo "ğŸ³ Testing Docker build..."
          
          # Test if Dockerfile exists and is valid
          if [ -f "Dockerfile" ]; then
            echo "âœ… Dockerfile found"
            
            # Check for hardcoded credentials in Dockerfile
            if grep -q "ENV.*PASSWORD\|ENV.*SECRET\|ENV.*KEY" Dockerfile; then
              echo "âŒ Hardcoded credentials found in Dockerfile"
              exit 1
            else
              echo "âœ… No hardcoded credentials in Dockerfile"
            fi
          else
            echo "âŒ Dockerfile not found"
            exit 1
          fi

      - name: Test Cloud Build Configuration
        run: |
          echo "â˜ï¸ Testing Cloud Build configuration..."
          
          if [ -f "cloudbuild.yaml" ]; then
            echo "âœ… cloudbuild.yaml found"
            
            # Validate YAML syntax
            python -c "import yaml; yaml.safe_load(open('cloudbuild.yaml')); print('âœ… cloudbuild.yaml syntax valid')"
          else
            echo "âŒ cloudbuild.yaml not found"
            exit 1
          fi

      - name: Update Project Board with Test Results
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const issueNumbers = pr.body.match(/#(\d+)/g);
            
            if (issueNumbers) {
              issueNumbers.forEach(issueRef => {
                const issueNum = issueRef.replace('#', '');
                
                try {
                  // Add test results comment to issue
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNum,
                    body: `ğŸ§ª **Deployment Test Results**\n\nPR: #${pr.number}\nStatus: âœ… All tests passed\n\n**Tests Passed:**\n- âœ… Docker build test\n- âœ… Cloud Build configuration test\n- âœ… No hardcoded credentials detected\n\nReady for review and merge! ğŸš€`
                  });
                  console.log(`âœ… Successfully commented on issue #${issueNum}`);
                } catch (error) {
                  console.log(`âš ï¸ Could not comment on issue #${issueNum}: ${error.message}`);
                  console.log(`This is not a critical error - tests still passed`);
                }
              });
            }
